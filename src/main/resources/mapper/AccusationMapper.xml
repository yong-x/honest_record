<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.xy.honest_record.mapper.AccusationMapper">


    <resultMap id="AccusationMap" type="Accusation">

        <id property="aId" column="a_id"></id>
        <result property="ptId" column="pt_id"></result>
        <result property="pfId" column="pf_id"></result>
        <result property="atId" column="at_id"></result>
        <result property="accusedUserId" column="accused_user_id"></result>
        <result property="accuserName" column="accuser_name"></result>
        <result property="accuserPhone" column="accuser_phone"></result>
        <result property="accuseDate" column="accuse_date"></result>
        <result property="dealDate" column="deal_date"></result>
        <result property="dealerUserId" column="dealer_user_id"></result>
        <result property="createTime" column="create_time"></result>
        <result property="updateTime" column="update_time"></result>
        <result property="checkState" column="check_state"></result>
        <result property="deleted" column="deleted"></result>

        <association property="faculty" javaType="Faculty">
            <id property="userId" column="user_id"></id>
            <result property="dId" column="d_id"></result>
            <result property="userName" column="user_name"></result>
            <result property="password" column="password"></result>
            <result property="gender" column="gender"></result>
            <result property="idCard" column="id_card"></result>
            <result property="phone" column="phone"></result>
            <result property="position" column="position"></result>
            <result property="workStartTime" column="work_start_time"></result>
            <result property="workState" column="work_state"></result>
            <result property="rId" column="r_id"></result>
            <result property="createTime" column="f_create_time"></result>
            <result property="updateTime" column="f_update_time"></result>
            <result property="checkState" column="f_check_state"></result>
            <result property="deleted" column="f_deleted"></result>
        </association>
        <association property="problemField" javaType="ProblemField">
            <id property="pfId" column="pf_pf_id"></id>
            <result property="pfName" column="pf_pf_name"></result>
            <result property="createTime" column="pf_create_time"></result>
            <result property="updateTime" column="pf_update_time"></result>
            <result property="deleted" column="pf_deleted"></result>
        </association>
        <association property="problemType" javaType="ProblemType">
            <id property="ptId" column="pt_ptid"></id>
            <result property="ptName" column="ptname"></result>
            <result property="createTime" column="pt_create_time"></result>
            <result property="updateTime" column="pt_update_time"></result>
            <result property="deleted" column="pt_deleted"></result>
        </association>
        <association property="accuseType" javaType="AccuseType">
            <id property="atId" column="at_atid"></id>
            <result property="atName" column="atname"></result>
            <result property="createTime" column="at_create_time"></result>
            <result property="updateTime" column="at_update_time"></result>
            <result property="deleted" column="at_deleted"></result>
        </association>
    </resultMap>

    <select id="allInfoQuery" resultMap="AccusationMap">
        select t.*,`at`.at_id as at_atid,`at`.at_name as atname,`at`.create_time as at_create_time,`at`.update_time as at_update_time,`at`.deleted as at_deleted
        from
        (select t2.*,pt.pt_id as pt_ptid,pt.pt_name as ptname,pt.create_time as pt_create_time,pt.update_time as pt_update_time,pt.deleted as pt_deleted
        from
        (select t1.*,pf.pf_id as pf_pf_id,pf.pf_name as pf_pf_name,pf.create_time as pf_create_time,pf.update_time as pf_update_time,pf.deleted as pf_deleted
        from
        (select a.*,f.user_id,f.d_id,f.user_name,f.password,f.gender,f.id_card,phone,position,work_start_time,work_state,f.r_id,f.create_time as f_create_time,f.update_time as f_update_time,f.check_state as f_check_state,f.deleted as f_deleted
        from accusation a
        LEFT JOIN faculty f on a.accused_user_id = f.user_id) t1
        LEFT JOIN problem_field pf on t1.pf_id = pf.pf_id) t2
        LEFT JOIN problem_type pt on t2.pt_id = pt.pt_id) t
        LEFT JOIN accuse_type `at` on t.at_id = `at`.at_id
        <where>
            ${ew.sqlSegment}
        </where>
    </select>

    <select id="analysisByTableName" resultType="AnaysisDataVo">


        select tem.${ForeignFeildName} as name,t.count as value
        from (select ${ForeignId},count(${ForeignId}) as count from accusation
        <where>
            <if test="startDate!=null">
                and accuse_date >= #{startDate}
            </if>
            <if test="endDate!=null">
                and accuse_date &lt; #{endDate}
            </if>
        </where>
        GROUP BY ${ForeignId}) t
        LEFT JOIN ${ForeigntableName} tem on t.${ForeignId}=tem.${ForeignId}


    </select>


</mapper>
